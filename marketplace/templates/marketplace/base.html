

{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Personal Shoppers{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Choices.js (multi-select ligero) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />

    <!-- CSS propio -->
    <link rel="stylesheet" href="{% static 'marketplace/css/styles.css' %}" />

    {% block extra_head %}{% endblock %}
  </head>
  <body>
    <!-- HEADER / NAVBAR -->
    <header class="ps-header border-bottom">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
          <a class="navbar-brand fw-bold" href="{% url 'home' %}">
            personalshoppers
          </a>

          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="mainNavbar">
            <!-- Navegación principal izquierda -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a
                  class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                  href="{% url 'home' %}"
                >
                  Inicio
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link {% if request.resolver_match.url_name == 'buscar_shoppers' %}active{% endif %}"
                  href="{% url 'buscar_shoppers' %}"
                >
                  Buscar shoppers
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link {% if request.resolver_match.url_name == 'como_funciona' %}active{% endif %}"
                  href="{% url 'como_funciona' %}"
                >
                  Cómo funciona
                </a>
              </li>
            </ul>

            <!-- Navegación derecha: login / perfil -->
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
              {% if user.is_authenticated %}
              <li class="nav-item dropdown">
                <button
                  class="btn btn-outline-light d-flex align-items-center gap-2 dropdown-toggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  {# Avatar del usuario / shopper #}
                  {% if user.shopperprofile and user.shopperprofile.photo_url %}
                    <img
                      src="{{ user.shopperprofile.photo_url }}"
                      alt="Foto"
                      class="rounded-circle"
                      style="width: 28px; height: 28px; object-fit: cover;"
                    />
                  {% else %}
                    <div
                      class="rounded-circle d-flex align-items-center justify-content-center bg-secondary text-white"
                      style="width: 28px; height: 28px; font-size: 0.8rem;"
                    >
                      {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                  {% endif %}

                  <span class="text-start">
                    <span class="d-block">
                      {{ user.get_full_name|default:user.username }}
                    </span>
                    {% if user.shopperprofile %}
                    <small class="d-block text-muted" style="font-size: 0.7rem;">
                      Shopper
                    </small>
                    {% elif user.customerprofile %}
                    <small class="d-block text-muted" style="font-size: 0.7rem;">
                      Cliente
                    </small>
                    {% endif %}
                  </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="{% url 'mi_perfil' %}">
                      Mi perfil
                    </a>
                  </li>
                  {% if user.shopperprofile %}
                  <li>
                    <a class="dropdown-item" href="{% url 'shopper_dashboard' %}">
                      Panel de shopper
                    </a>
                  </li>
                  {% elif user.customerprofile %}
                  <li>
                    <a class="dropdown-item" href="{% url 'customer_dashboard' %}">
                      Panel de cliente
                    </a>
                  </li>
                  {% endif %}
                  <li><hr class="dropdown-divider" /></li>

                  {# Logout por POST para evitar Method Not Allowed (GET) #}
                  <li>
                    <form method="post" action="{% url 'logout' %}" class="m-0">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item">
                        Cerrar sesión
                      </button>
                    </form>
                  </li>
                </ul>
              </li>
              {% else %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}">Iniciar sesión</a>
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Registrarme
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="{% url 'register_customer' %}">
                      Soy cliente
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{% url 'register_shopper' %}">
                      Soy shopper
                    </a>
                  </li>
                </ul>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- CONTENIDO -->
    <main class="py-4">
      <div class="container">
        {% if messages %}
          <div class="mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} mb-2" role="alert">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% block content %}{% endblock %}
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="py-4 border-top text-center text-muted small">
      <div class="container">
        &copy; {% now "Y" %} Personal Shoppers
        · <a href="{% url 'faqs' %}" class="text-muted text-decoration-none">FAQs</a>
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    ></script>

    <!-- Choices.js -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
      // Inicialización global: cualquier <select multiple> con class="js-multiselect"
      // queda compacto y se expande al interactuar.
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("select.js-multiselect").forEach(function (el) {
          if (el.dataset.choicesInit === "1") return;
          el.dataset.choicesInit = "1";

          new Choices(el, {
            removeItemButton: true,
            shouldSort: false,
            placeholder: true,
            placeholderValue: "Seleccioná...",
            searchEnabled: false,
            itemSelectText: "",
          });
        });
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
